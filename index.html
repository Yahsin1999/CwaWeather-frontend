<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="./image.png">
    
    <title>ä»Šæ—¥å¤©æ°£é å ±ğŸŒ</title>

    <!-- ç”±æ–¼ç„¡æ³•è¼‰å…¥å¤–éƒ¨æª”æ¡ˆï¼Œæˆ‘å€‘ç§»é™¤ favicon link: <link rel="icon" type="image/png" href="./icon-v2.png"> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- ä½¿ç”¨ Zen Maru Gothic ä½œç‚ºä¸»è¦çš„æ’ç•«å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
        <style>
        :root {
            /* æ£®æ£®å¤©æ°£çš„ä¸»é¡Œè‰² */
            --primary-brown: #8B6F47;
            --primary-cream: #FFF9ED; /* ä¸»è¦å¡ç‰‡é¡è‰² */
            --primary-yellow: #FFD291; /* è¼”åŠ©å¡ç‰‡é¡è‰² */
            --primary-green: #A7B49E; /* æ¨™ç±¤é¡è‰² */
            --card-shadow: #E0D6C2; /* å¡ç‰‡é™°å½±è‰² */
            --error-red: #D82E2F;
            --error-shadow: #F9BABA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--primary-brown);
            /* æŸ”å’Œçš„èƒŒæ™¯æ¼¸å±¤ï¼Œæ¨¡æ“¬ç™½å¤©åˆ°å¤œæ™šçš„éæ¸¡ */
            background: linear-gradient(to bottom, #A7D8FF 0%, #FFDDAA 100%);
            position: relative;
        }

        /* é›²æœµå‹•ç•« (å¢åŠ ç¸®æ”¾è®ŠåŒ–) */
        .cloud {
            position: absolute;
            top: 100px; /* ä¿®æ­£: å¾€ä¸‹ç§»ï¼Œé¿å…è¢«å°è¦½åˆ—æ“‹ä½ */
            width: 150px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.7;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
            animation: moveClouds 60s linear infinite, scaleClouds 10s ease-in-out infinite alternate;
            z-index: 1; /* ç¢ºä¿åœ¨èƒŒæ™¯å±¤ï¼Œä½æ–¼ status-bar (z-index: 100) */
        }

        .cloud:nth-child(2) {
            top: 150px; /* ä¿®æ­£: å¾€ä¸‹ç§» */
            width: 120px;
            height: 60px;
            animation-duration: 80s;
            animation-delay: -30s;
            opacity: 0.6;
        }

        @keyframes moveClouds {
            0% { left: -200px; }
            100% { left: 100%; }
        }

        @keyframes scaleClouds {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        /* é ‚éƒ¨ç‹€æ…‹åˆ— */
        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center; /* ä¿æŒæ°´å¹³ç½®ä¸­ */
            padding: 10px 20px;
            /* ä½¿ç”¨æ›´æŸ”å’Œçš„èƒŒæ™¯ */
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* åŸå¸‚é¸æ“‡ç¾¤çµ„ï¼šå°‡ä¸‹æ‹‰é¸å–®å’Œæç¤ºæ–‡å­—å †ç–Š */
        .city-selector-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px; /* ä¸‹æ‹‰é¸å–®å’Œæç¤ºæ–‡å­—ä¹‹é–“çš„é–“è· */
        }

        /* æç¤ºæ–‡å­—æ¨£å¼ */
        .city-select-hint {
            font-size: 0.8rem;
            color: var(--primary-brown);
            font-weight: 400; /* è¼•ç›ˆçš„å­—é‡ */
            opacity: 0.8;
            /* å¢åŠ ä¸€é»æ‰‹å¯«ç­†è·¡æ„Ÿ */
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
            margin-bottom: 5px; /* å¢åŠ èˆ‡ä¸‹é¢å…§å®¹çš„é–“è· */
        }

        .city-select {
            padding: 8px 16px;
            border-radius: 25px;
            border: 3px solid white;
            /* ä½¿ç”¨ä¸»é¡Œè‰²æ¼¸å±¤ */
            background: linear-gradient(145deg, var(--primary-yellow), #FFE9B1);
            color: var(--primary-brown);
            font-weight: 700;
            font-size: 1.1rem;
            /* å¼·çƒˆçš„è²¼ç´™é™°å½± */
            box-shadow: 4px 4px 0px var(--card-shadow);
            cursor: pointer;
            appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
        }
        
        .container {
            padding: 20px;
            max-width: 640px;
            /* ä½¿ç”¨ auto ç¢ºä¿å®¹å™¨åœ¨ä»»ä½•å°ºå¯¸ä¸‹éƒ½ç½®ä¸­ */
            margin: 0 auto; 
        }

        /* Hero å¡ç‰‡ (æ•´é«”è²¼ç´™å¤–è§€) */
        .hero-card-wrapper {
            background: linear-gradient(145deg, var(--primary-cream), #FFE6C4);
            border-radius: 35px;
            padding: 30px 25px;
            text-align: center;
            box-shadow: 6px 6px 0px var(--card-shadow); /* æ›´æ·±çš„é™°å½± */
            border: 4px solid white; /* ç™½è‰²æé‚Š */
            margin-bottom: 25px;
            position: relative;
            transition: transform 0.2s ease-out;
        }
        .hero-card-wrapper:active {
            transform: translate(2px, 2px);
            box-shadow: 4px 4px 0px var(--card-shadow);
        }

        .hero-date {
            font-size: 1.1rem;
            font-weight: 700;
            color: #7A6A5A;
            margin-bottom: 15px;
        }

        /* æ™‚æ®µæ¨™ç±¤ (åƒä¾¿åˆ©è²¼) */
        .hero-period {
            position: absolute;
            top: -18px; /* å‘ä¸Šç§»å‹•ä»¥è¦†è“‹é‚Šç·£ */
            left: 50%;
            transform: translateX(-50%) rotate(-2deg); /* å¾®å¦™æ—‹è½‰å¢åŠ æ‰‹ç¹ªæ„Ÿ */
            background: var(--primary-green);
            color: white;
            padding: 6px 22px;
            border-radius: 20px;
            font-weight: 900;
            border: 3px solid white;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
            transition: transform 0.1s ease-out;
        }

        /* ä¿®æ­£ï¼šå°‡åœ–æ¨™å’Œæº«åº¦ä¸¦æ’ä¸”ç½®ä¸­ */
        .hero-temp-container {
            display: flex;
            justify-content: center; /* æ°´å¹³ç½®ä¸­ */
            align-items: flex-end; /* è®“æº«åº¦æ•¸å­—å’Œåœ–æ¨™åº•éƒ¨å°é½Šï¼Œè¦–è¦ºä¸Šæ›´å¥½ */
            margin-bottom: 10px; 
            margin-top: 10px; /* å¢åŠ èˆ‡æ—¥æœŸ/æ™‚æ®µçš„é–“è· */
        }

        .hero-icon {
            font-size: 6rem; /* æ”¾å¤§ä¸»è¦åœ–æ¨™ */
            /* å¢åŠ åœ–æ¨™èˆ‡æº«åº¦æ•¸å­—çš„é–“è· */
            margin-right: 15px; 
            filter: drop-shadow(0 5px 0 rgba(0, 0, 0, 0.1));
            animation: bounce 3s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .hero-temp {
            font-size: 5.5rem; /* æ›´å¤§çš„æº«åº¦æ•¸å­— */
            font-weight: 900;
            line-height: 1;
        }

        .hero-desc {
            font-size: 1.5rem;
            color: var(--primary-brown);
            margin-bottom: 20px;
            font-weight: 900;
        }

        /* å»ºè­°å€ */
        .advice-item {
            /* èª¿æ•´æ¼¸å±¤è®“å®ƒæ›´æŸ”å’Œ */
            background: linear-gradient(145deg, #FFFBED, #FFE9B1);
            padding: 15px;
            border-radius: 25px;
            box-shadow: 3px 3px 0px var(--card-shadow);
            border: 2px solid white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .advice-grid {
            display: grid;
            /* æ¡Œé¢ç‰ˆ/å¤§è¢å¹•é è¨­ç‚ºå…©æ¬„ */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
        }

        .advice-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .advice-text {
            font-size: 1.2rem;
            font-weight: 900;
            margin: 5px 0;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--primary-brown);
            margin-bottom: 15px;
            margin-left: 10px;
            font-weight: 900;
        }

        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            /* ä¿®æ­£ï¼šå¼·åˆ¶è¨­å®šç‚ºä¸æ›è¡Œï¼Œç¢ºä¿æ°´å¹³æ»¾å‹• */
            flex-wrap: nowrap; 
            /* ä¿®æ­£ï¼šç¢ºä¿æ‰€æœ‰å¡ç‰‡é ‚éƒ¨å°é½Šï¼Œè§£æ±ºå‚ç›´éŒ¯ä½çš„å•é¡Œ */
            align-items: flex-start;
        }

        .scroll-container::-webkit-scrollbar {
            display: none;
        }

        /* æ»‘å‹•é å ±å¡ç‰‡ */
        .mini-card {
            min-width: 150px; /* ç¨å¾®æ”¾å¤§ */
            background: linear-gradient(145deg, #FFF9ED, #FFEEC9);
            border-radius: 25px;
            padding: 15px 10px;
            border: 3px solid white;
            box-shadow: 3px 3px 0px var(--card-shadow);
            transition: transform 0.2s ease-out;
            text-align: center;
            flex-shrink: 0;
        }

        .mini-card:active {
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0px var(--card-shadow);
        }

        .mini-time {
            background: var(--primary-green);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            border: 2px solid white;
            font-weight: 900;
            display: inline-block;
            margin-bottom: 10px;
        }

        .mini-icon {
            font-size: 2.5rem;
            margin: 5px 0;
        }

        .mini-temp {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-brown);
        }

        /* Loading ç•«é¢ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #A7D8FF;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .loading-screen p {
            color: white;
            font-weight: bold;
            margin-top: 20px;
        }

        /* è‡ªå®šç¾©éŒ¯èª¤è¨Šæ¯æ¡† (å–ä»£ alert) */
        .error-box-wrapper {
            padding-top: 50px;
        }
        .error-box {
            background: #FFF0F0;
            border: 3px solid #FFD2D2;
            color: var(--error-red);
            padding: 30px;
            border-radius: 35px;
            text-align: center;
            font-weight: 700;
            box-shadow: 5px 5px 0px var(--error-shadow);
        }
        .error-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* ============================================== */
        /* ğŸ“± æ‰‹æ©ŸéŸ¿æ‡‰å¼æ¨£å¼ (Max-width: 650px) ğŸ“± */
        /* ============================================== */
        @media (max-width: 650px) {
            
            /* èª¿æ•´ä¸»å®¹å™¨ paddingï¼Œè®“å…§å®¹æ›´è²¼è¿‘é‚Šç·£ */
            .container {
                padding: 15px 10px; /* å·¦å³é‚Šè·æ¸›å°‘ */
            }

            /* ç¸®å° Hero Card å…§çš„å…ƒç´ ï¼Œé¿å…éåº¦æ“æ“  */
            .hero-icon {
                font-size: 5rem; /* ç¸®å°åœ–æ¨™ */
                margin-right: 10px;
            }

            .hero-temp {
                font-size: 4.5rem; /* ç¸®å°æº«åº¦æ•¸å­— */
            }
            
            .hero-desc {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            /* å»ºè­°å€å¡Šï¼šå¾å…©æ¬„æ”¹ç‚ºå–®æ¬„å †ç–Š (æ›´é©åˆå‚ç›´é–±è®€) */
            .advice-grid {
                grid-template-columns: 1fr; /* æ”¹ç‚ºå–®æ¬„ */
                gap: 10px; /* æ¸›å°‘é–“è· */
            }
            
            /* å»ºè­°é …ç›® padding ç¨å¾®ç¸®å° */
            .advice-item {
                padding: 12px;
            }
            
            .advice-text {
                font-size: 1.1rem;
            }

            /* ç¢ºä¿åº•éƒ¨æ»¾å‹•é å ±å¡ç‰‡å¯¬åº¦åˆç† */
            .mini-card {
                min-width: 120px; /* ç¨å¾®ç¸®å°ï¼Œè®“æ›´å¤šå¡ç‰‡å¯ä»¥é¡¯ç¤º */
            }

            /* åŸå¸‚é¸å–®å­—é«”åœ¨æ‰‹æ©Ÿä¸Šç¨å¾®ç¸®å° */
            .city-select {
                font-size: 1rem; 
                padding: 7px 14px;
            }
        }
    </style>
</head>

<body>
    <!-- é›²æœµå‹•ç•« -->
    <!-- èª¿æ•´ top å±¬æ€§ï¼Œç¢ºä¿é›²æœµå¾å°è¦½åˆ—ä¸‹æ–¹é–‹å§‹é£„å‹• -->
    <div class="cloud" style="left: 10%;"></div>
    <div class="cloud" style="left: 50%; animation-delay: -50s;"></div>

    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading" class="loading-screen">
        <div style="font-size: 4rem; animation: bounce 2s infinite;">â˜ï¸</div>
        <p>æ£®æ£®æ­£åœ¨è§€æ¸¬é›²çš„æµå‹•...</p>
    </div>

    <!-- ç‹€æ…‹åˆ— (åŸå¸‚é¸æ“‡) - åŒ…å«æç¤ºæ–‡å­— -->
    <div class="status-bar">
        <div class="city-selector-group">
            <select id="citySelect" class="city-select">
                <option value="è‡ºåŒ—å¸‚">ğŸ™ï¸ è‡ºåŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">ğŸŒ† æ–°åŒ—å¸‚</option>
                <option value="æ¡ƒåœ’å¸‚">ğŸŒ¸ æ¡ƒåœ’å¸‚</option>
                <option value="è‡ºä¸­å¸‚">ğŸï¸ è‡ºä¸­å¸‚</option>
                <option value="è‡ºå—å¸‚">ğŸŒ´ è‡ºå—å¸‚</option>
                <option value="é«˜é›„å¸‚">ğŸ–ï¸ é«˜é›„å¸‚</option>
                <option value="åŸºéš†å¸‚">ğŸš¢ åŸºéš†å¸‚</option>
            </select>
            <!-- æ–°å¢æç¤ºæ–‡å­— -->
            <div class="city-select-hint">é»é¸å¯æ›´æ›ç¸£å¸‚</div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="container" id="mainContent" style="display: none;">
        <div id="heroCard">
            <!-- ä¸»è¦å¡ç‰‡å…§å®¹å°‡ç”± JS æ¸²æŸ“åˆ°é€™è£¡ -->
        </div>

        <h3 class="section-title">ç¨å¾Œé å ±</h3>
        <div class="scroll-container" id="futureForecasts">
            <!-- ç¨å¾Œé å ±å¡ç‰‡å°‡ç”± JS æ¸²æŸ“åˆ°é€™è£¡ -->
        </div>
    </div>

    <script type="module">
        // =========================================================================
        // ğŸ“Œ é€™è£¡åŠ å…¥äº† Firebase ç›¸é—œçš„åˆå§‹åŒ–ç¨‹å¼ç¢¼ (ä¾› Canvas ç’°å¢ƒä½¿ç”¨)
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // æš«æ™‚ä¸éœ€è¦ Firestore

        // --- è®€å– Canvas ç’°å¢ƒæä¾›çš„å…¨åŸŸè®Šæ•¸ ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, userId; // Firebase/Auth å¯¦ä¾‹

        async function initializeFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    // db = getFirestore(app); // åˆå§‹åŒ– Firestore
                    
                    if (initialAuthToken) {
                        // ä½¿ç”¨è‡ªè¨‚ Token ç™»å…¥
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase Auth: Signed in with custom token.");
                    } else {
                        // åŒ¿åç™»å…¥ (å¦‚æœæ²’æœ‰æä¾› Token)
                        await signInAnonymously(auth);
                        console.log("Firebase Auth: Signed in anonymously.");
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                } else {
                    console.warn("Firebase config is missing. Skipping Firebase initialization.");
                }
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        // =========================================================================

        // ğŸš¨ é€™æ˜¯æ‚¨çš„ API Endpointï¼Œä¿æŒä¸è®Š
        const API_URL = (city) => `https://weather--taiwan.zeabur.app/api/weather/${city}`;

        /**
         * æ ¹æ“šå¤©æ°£æè¿°å–å¾— Emoji åœ–æ¨™ (æ’ç•«é¢¨æ ¼)
         */
        function getWeatherIcon(weather) {
            if (!weather) return "ğŸŒ¤ï¸";
            // æ›´å¤šæ¨£åŒ–çš„ Emoji é¸æ“‡ï¼Œå¢åŠ å¯æ„›æ„Ÿ
            if (weather.includes("æ™´")) return "ğŸŒ"; // æ›´æº«æš–çš„å¤ªé™½
            if (weather.includes("å¤šé›²")) return "ğŸŒ¥ï¸";
            if (weather.includes("é™°")) return "â˜ï¸";
            if (weather.includes("é›¨")) return "â˜”"; // å¸¶é›¨å‚˜çš„ Emoji
            if (weather.includes("é›·")) return "â›ˆï¸";
            if (weather.includes("éœ§")) return "ğŸŒ«ï¸";
            return "ğŸŒˆ"; // é è¨­ä½¿ç”¨å½©è™¹
        }

        /**
         * æ ¹æ“šé™é›¨ç‡å’Œæœ€é«˜æº«æä¾›ç©¿æ­èˆ‡é›¨å…·å»ºè­°
         */
        function getAdvice(rainProb, maxTemp) {
            const rain = parseInt(rainProb);
            const temp = parseInt(maxTemp);

            let rainIcon = "ğŸ‘";
            let rainText = "æ”¾å¿ƒå‡ºé–€å»ï¼";
            if (rain > 50) {
                rainIcon = "â˜”";
                rainText = "å‹™å¿…å¸¶å‚˜ï¼";
            } else if (rain > 20) {
                rainIcon = "ğŸŒ‚";
                rainText = "å»ºè­°å¸¶å‚˜";
            }

            let clothIcon = "ğŸ‘•";
            let clothText = "èˆ’é©çŸ­è¢–";
            if (temp >= 30) {
                clothIcon = "ğŸ¥µ";
                clothText = "è¶…ç´šç†±ï¼æ¸…æ¶¼ç©¿æ­";
            } else if (temp <= 20 && temp > 15) {
                clothIcon = "ğŸ§¥";
                clothText = "åŠ ä»¶è–„å¤–å¥—";
            } else if (temp <= 15) {
                clothIcon = "ğŸ§£";
                clothText = "åšå¤–å¥—/åœå·¾";
            }

            return { rainIcon, rainText, clothIcon, clothText };
        }

        /**
         * å–å¾—æ™‚é–“æ®µ (æ—©æ™¨/ä¸­åˆ/ä¸‹åˆ/å‚æ™š/æ·±å¤œ)
         * ä¿®æ­£æ™‚æ®µé‚è¼¯ï¼Œæ¶µè“‹æ‰€æœ‰ 24 å°æ™‚
         */
        function getTimePeriod(time) {
            const hour = new Date(time).getHours();
            if (hour >= 5 && hour < 11) return "æ—©æ™¨";
            if (hour >= 11 && hour < 14) return "ä¸­åˆ";
            if (hour >= 14 && hour < 18) return "ä¸‹åˆ";
            if (hour >= 18 && hour < 21) return "å‚æ™š";
            // 21:00 åˆ°éš”æ—¥ 04:59 è¦–ç‚ºæ·±å¤œ
            if (hour >= 21 || hour < 5) return "æ·±å¤œ"; 
            return "æ™‚æ®µ"; // è¬ä¸€ç„¡æ³•åˆ¤æ–·æ™‚çš„å›é€€
        }

        /**
         * æ¸²æŸ“å¤©æ°£è³‡æ–™åˆ° UI
         */
        function renderWeather(data) {
            const forecasts = data.forecasts;
            const now = new Date();

            // 1. å–å¾—ä»Šå¤©æ—¥æœŸå­—ä¸²
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayIndex = now.getDay();
            const days = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
            const todayStr = `${month}/${date}ï¼ˆ${days[dayIndex]}ï¼‰`;

            const heroCardContainer = document.getElementById('heroCard');
            const scrollContainer = document.getElementById('futureForecasts');

            // æª¢æŸ¥ forecasts çµæ§‹
            if (forecasts.length === 0 || !forecasts[0] || !forecasts[0].startTime) {
                heroCardContainer.innerHTML = `
                    <div class="error-box-wrapper">
                        <div class="error-box">
                            <div class="error-icon">âŒ</div>
                            <p>ç„¡æ³•å–å¾—é å ±è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
                            <div style="font-size:0.8rem; margin-top:10px;">(API å›å‚³è³‡æ–™çµæ§‹éŒ¯èª¤æˆ–ç„¡è³‡æ–™)</div>
                        </div>
                    </div>
                `;
                scrollContainer.innerHTML = '';
                return;
            }

            // 2. æ‰¾å‡ºç•¶å‰æ™‚é–“é»çš„é å ±
            let current = null;
            let currentIndex = -1;

            for (let i = 0; i < forecasts.length; i++) {
                const f = forecasts[i];
                f.startTimeDate = new Date(f.startTime);

                // è¨ˆç®—ç•¶å‰é å ±å€é–“çš„çµæŸæ™‚é–“
                const endTime = (i + 1 < forecasts.length)
                                        ? new Date(forecasts[i + 1].startTime)
                                        : new Date(now.getTime() + 6 * 60 * 60 * 1000); // å¦‚æœæ˜¯æœ€å¾Œä¸€ç­†ï¼Œå‰‡é è¨­ 6 å°æ™‚å¾ŒçµæŸ

                if (now < endTime) {
                    current = f;
                    currentIndex = i;
                    break;
                }
            }

            if (!current) {
                // å¦‚æœæ‰¾ä¸åˆ°å€é–“ï¼ˆä¾‹å¦‚æ™‚é–“å·²ç¶“è¶…éæ‰€æœ‰é å ±ï¼‰ï¼Œå‰‡ä½¿ç”¨æœ€å¾Œä¸€å€‹å€é–“
                current = forecasts[forecasts.length - 1];
                currentIndex = forecasts.length - 1;
            }

            // 3. æ¸²æŸ“ä¸»è¦å¡ç‰‡
            const nowPeriod = getTimePeriod(current.startTime);
            const advice = getAdvice(current.rain, current.maxTemp);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);

            heroCardContainer.innerHTML = `
                <div class="hero-card-wrapper">
                    <div class="hero-period">${nowPeriod}</div>
                    <div class="hero-date">${todayStr}</div>
                    <div class="hero-temp-container">
                        <div class="hero-icon">${getWeatherIcon(current.weather)}</div>
                        <div class="hero-temp">${avgTemp}Â°</div>
                    </div>
                    <div class="hero-desc">${current.weather}</div>
                    
                    <div class="advice-grid">
                        <div class="advice-item">
                            <div class="advice-icon">${advice.rainIcon}</div>
                            <div class="advice-text">${advice.rainText}</div>
                            <div style="font-size:0.7rem; color:#999">é™é›¨ç‡ ${current.rain}</div>
                        </div>
                        <div class="advice-item">
                            <div class="advice-icon">${advice.clothIcon}</div>
                            <div class="advice-text">${advice.clothText}</div>
                            <div style="font-size:0.7rem; color:#999">æœ€é«˜æº« ${current.maxTemp}Â°</div>
                        </div>
                    </div>
                </div>
            `;

            // 4. æ¸²æŸ“ç¨å¾Œé å ±å¡ç‰‡
            // å¾ç•¶å‰ç´¢å¼•çš„ä¸‹ä¸€å€‹é–‹å§‹ï¼Œå– 3 å€‹é å ±
            const others = forecasts.slice(currentIndex + 1, currentIndex + 1 + 3);

            scrollContainer.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

            if (others.length === 0) {
                scrollContainer.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--primary-brown); font-weight: bold; font-size: 0.9rem; min-width: 100%;">ä»Šå¤©çš„é å ±å·²çµæŸï¼Œè«‹ç­‰å¾…ä¸‹ä¸€æ¬¡è³‡æ–™æ›´æ–°ã€‚</div>';
                return;
            }

            const todayDateNum = new Date().getDate();

            others.forEach(f => {
                let p = getTimePeriod(f.startTime); 
                const fDate = new Date(f.startTime);
                
                let timeLabel = p;
                if (fDate.getDate() !== todayDateNum) {
                    timeLabel = "æ˜å¤©" + p;
                }

                scrollContainer.innerHTML += `
                    <div class="mini-card">
                        <div class="mini-time">${timeLabel}</div>
                        <div class="mini-icon">${getWeatherIcon(f.weather)}</div>
                        <div class="mini-temp">${f.minTemp}Â° - ${f.maxTemp}Â°</div>
                        <div style="font-size:0.8rem; color:#888; margin-top:5px;">ğŸ’§ ${f.rain}</div>
                    </div>
                `;
            });
        }

        /**
         * ç²å–å¤©æ°£è³‡æ–™ä¸¦è™•ç†è¼‰å…¥ç‹€æ…‹
         */
        async function fetchWeather() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            try {
                const city = document.getElementById("citySelect").value;
                // åŠ å…¥å»¶é²ç¢ºä¿è¼‰å…¥å‹•ç•«èƒ½é¡¯ç¤º
                const delayPromise = new Promise(resolve => setTimeout(resolve, 800)); 
                
                // ç”±æ–¼æ­¤ API_URL æ˜¯å¤–éƒ¨æœå‹™ï¼Œæˆ‘å€‘ç›´æ¥å‘¼å«å®ƒ
                const response = await fetch(API_URL(city));
                const json = await response.json();
                
                await delayPromise; // ç­‰å¾…å»¶é²çµæŸ

                if (json.success) {
                    renderWeather(json.data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    // API å›å‚³éŒ¯èª¤æ™‚
                    throw new Error(json.error || "API å›å‚³éŒ¯èª¤");
                }
            } catch (e) {
                console.error("å¤©æ°£è³‡æ–™è®€å–å¤±æ•—:", e);
                // ä¿®æ­£ï¼šç”¨ custom message box æ›¿ä»£ alert()
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('heroCard').innerHTML = `
                    <div class="error-box-wrapper">
                        <div class="error-box">
                            <div class="error-icon">ğŸ˜­</div>
                            <p>å¤©æ°£è³‡æ–™è®€å–å¤±æ•—ï¼</p>
                            <div style="font-size:0.8rem; margin-top:10px;">è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API ç‹€æ…‹ã€‚</div>
                        </div>
                    </div>
                `;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('futureForecasts').innerHTML = '';
            }
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener("DOMContentLoaded", async () => {
            // ç¢ºä¿ Firebase/Auth å®Œæˆåˆå§‹åŒ–å¾Œå†åŸ·è¡Œä¸»è¦æ‡‰ç”¨ç¨‹å¼é‚è¼¯
            await initializeFirebaseAndAuth(); 
            fetchWeather();
            document.getElementById("citySelect").addEventListener("change", fetchWeather);
        });
    </script>
</body>
</html>